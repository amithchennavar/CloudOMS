<!DOCTYPE html>
<html>
<head>
    <title>Order Management System</title>
    <link href="https://kendo.cdn.telerik.com/2023.3.1010/styles/kendo.default-v2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kendo.cdn.telerik.com/2023.3.1010/js/kendo.all.min.js"></script>
</head>
<body>
    <!-- Login Section -->
    <h2>Login</h2>
    <div id="loginSection" style="display: block;">
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button id="loginButton">Login</button>
        <div id="loginError" style="color: red;"></div>
    </div>
    <div id="logoutSection" style="display: none;">
        <button id="logoutButton">Logout</button>
    </div>

    <!-- Order Grid and Form -->
    <h2>Orders</h2>
    <div id="orderGrid"></div>
    <div>
        <input id="orderUserId" placeholder="User ID" />
        <input id="orderProductId" placeholder="Product ID" />
        <input id="orderQuantity" type="number" placeholder="Quantity" />
        <select id="orderStatus">
            <option value="Pending">Pending</option>
            <option value="Shipped">Shipped</option>
        </select>
        <button id="addOrder">Add Order</button>
    </div>

    <!-- Inventory Grid and Form -->
    <h2>Inventory</h2>
    <div id="inventoryGrid"></div>
    <div>
        <input id="inventoryProductId" placeholder="Product ID" />
        <input id="inventoryName" placeholder="Name" />
        <input id="inventoryStock" type="number" placeholder="Stock" />
        <input id="inventoryPrice" type="number" step="0.01" placeholder="Price" />
        <button id="addInventory">Add Inventory</button>
    </div>

    <script>
        let token = localStorage.getItem('jwtToken');

        $(document).ready(function () {
            // Login Functionality
            $("#loginButton").click(function () {
                var credentials = {
                    username: $("#username").val(),
                    password: $("#password").val()
                };
                $.ajax({
                    url: "https://localhost:44361/gateway/Users/login",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(credentials),
                    success: function (response) {
                        token = response.token;
                        localStorage.setItem('jwtToken', token);
                        $("#loginSection").hide();
                        $("#logoutSection").show();
                        $("#loginError").text("");
                        initializeGrids();
                    },
                    error: function (xhr) {
                        $("#loginError").text("Login failed: " + xhr.responseText);
                    }
                });
            });

            $("#logoutButton").click(function () {
                token = null;
                localStorage.removeItem('jwtToken');
                $("#loginSection").show();
                $("#logoutSection").hide();
                $("#orderGrid").data("kendoGrid").dataSource.read();
                $("#inventoryGrid").data("kendoGrid").dataSource.read();
            });

            // Initialize Grids if already logged in
            if (token) {
                $("#loginSection").hide();
                $("#logoutSection").show();
                initializeGrids();
            }

            function initializeGrids() {
                // Order Grid
                $("#orderGrid").kendoGrid({
                    dataSource: {
                        transport: {
                            read: {
                                url: "https://localhost:44361/gateway/Orders",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            create: {
                                url: "https://localhost:44361/gateway/Orders",
                                type: "POST",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            update: {
                                url: "https://localhost:44361/gateway/Orders/{id}",
                                type: "PUT",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            destroy: {
                                url: "https://localhost:44361/gateway/Orders/{id}",
                                type: "DELETE",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            }
                        },
                        schema: {
                            model: {
                                id: "id",
                                fields: {
                                    id: { type: "number", editable: false },
                                    userId: { type: "string", validation: { required: true } },
                                    productId: { type: "string", validation: { required: true } },
                                    quantity: { type: "number", validation: { required: true, min: 1 } },
                                    status: { type: "string", validation: { required: true } },
                                    orderDate: { type: "date", editable: false }
                                }
                            }
                        }
                    },
                    columns: [
                        { field: "id", title: "ID", editable: false },
                        { field: "userId", title: "User ID" },
                        { field: "productId", title: "Product ID" },
                        { field: "quantity", title: "Quantity" },
                        { field: "status", title: "Status", editor: categoryDropDownEditor },
                        { field: "orderDate", title: "Order Date", format: "{0:yyyy-MM-dd HH:mm:ss}", editable: false },
                        { command: ["edit", "destroy"], title: " " }
                    ],
                    editable: "popup",
                    toolbar: ["create"]
                });

                // Inventory Grid
                $("#inventoryGrid").kendoGrid({
                    dataSource: {
                        transport: {
                            read: {
                                url: "https://localhost:44361/gateway/Inventory",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            create: {
                                url: "https://localhost:44361/gateway/Inventory",
                                type: "POST",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            update: {
                                url: "https://localhost:44361/gateway/Inventory/{id}",
                                type: "PUT",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            },
                            destroy: {
                                url: "https://localhost:44361/gateway/Inventory/{id}",
                                type: "DELETE",
                                dataType: "json",
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                                }
                            }
                        },
                        schema: {
                            model: {
                                id: "id",
                                fields: {
                                    id: { type: "number", editable: false },
                                    productId: { type: "string", validation: { required: true } },
                                    name: { type: "string", validation: { required: true } },
                                    stock: { type: "number", validation: { required: true, min: 0 } },
                                    price: { type: "number", validation: { required: true, min: 0 } }
                                }
                            }
                        }
                    },
                    columns: [
                        { field: "id", title: "ID", editable: false },
                        { field: "productId", title: "Product ID" },
                        { field: "name", title: "Name" },
                        { field: "stock", title: "Stock" },
                        { field: "price", title: "Price", format: "{0:c}" },
                        { command: ["edit", "destroy"], title: " " }
                    ],
                    editable: "popup",
                    toolbar: ["create"]
                });

                $("#addOrder").click(function () {
                    var order = {
                        userId: $("#orderUserId").val(),
                        productId: $("#orderProductId").val(),
                        quantity: parseInt($("#orderQuantity").val()),
                        status: $("#orderStatus").val()
                    };
                    $.ajax({
                        url: "https://localhost:44361/gateway/Orders",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(order),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("Authorization", "Bearer " + token);
                        },
                        success: function () {
                            $("#orderGrid").data("kendoGrid").dataSource.read();
                            $("#orderUserId, #orderProductId, #orderQuantity").val("");
                        },
                        error: function (xhr) {
                            alert("Error: " + xhr.responseText);
                        }
                    });
                });

                $("#addInventory").click(function () {
                    var inventory = {
                        productId: $("#inventoryProductId").val(),
                        name: $("#inventoryName").val(),
                        stock: parseInt($("#inventoryStock").val()),
                        price: parseFloat($("#inventoryPrice").val())
                    };
                    $.ajax({
                        url: "https://localhost:44361/gateway/Inventory",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(inventory),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("Authorization", "Bearer " + token);
                        },
                        success: function () {
                            $("#inventoryGrid").data("kendoGrid").dataSource.read();
                            $("#inventoryProductId, #inventoryName, #inventoryStock, #inventoryPrice").val("");
                        },
                        error: function (xhr) {
                            alert("Error: " + xhr.responseText);
                        }
                    });
                });
            }

            // Custom editor for status dropdown
            function categoryDropDownEditor(container, options) {
                $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "text",
                        dataValueField: "value",
                        dataSource: [
                            { text: "Pending", value: "Pending" },
                            { text: "Shipped", value: "Shipped" }
                        ],
                        value: options.model[options.field]
                    });
            }
        });
    </script>
</body>
</html>